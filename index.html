<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>lamacOs — Kurzbefehle (All-in-one)</title>
<style>
:root{
  --bg: linear-gradient(180deg,#061219,#0b1220);
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
  --accent: #FFFFFF;
  --muted: rgba(255,255,255,0.65);
  --danger: rgba(255,80,80,0.95);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* base */
html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased;}
.app{min-height:100vh;display:flex;flex-direction:column;gap:14px;padding:18px;box-sizing:border-box;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.title{font-weight:800;font-size:20px;display:flex;gap:8px;align-items:center;}

/* plus button (glass look) */
.plus{
  width:52px;height:52px;border-radius:12px;display:grid;place-items:center;
  background:linear-gradient(180deg,var(--glass),var(--glass-2));
  border:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(12px) saturate(120%);
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);cursor:pointer;font-size:28px;user-select:none;
  transition: transform 0.12s, box-shadow 0.12s;
}
.plus:hover{box-shadow:0 12px 30px rgba(0,0,0,0.7), 0 0 12px rgba(255,255,255,0.08);}
.plus:active{transform:scale(0.96);}

/* layout */
.content{display:flex;gap:12px;align-items:flex-start;width:100%;}
.sidebar{min-width:220px;max-width:300px;flex:0 0 auto;}
.cards{flex:1 1 auto;display:grid;gap:12px;}
.card{padding:12px;border-radius:12px;background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(10px);box-shadow: 0 10px 28px rgba(0,0,0,0.55);
  display:flex;gap:12px;align-items:center;cursor:pointer;transition:transform 0.15s ease;}
.card:hover{transform:translateY(-2px);}
.card .meta{flex:1}
.card .name{font-weight:700}
.card .desc{font-size:13px;color:var(--muted);margin-top:4px}
.icon{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-size:22px;border:1px solid rgba(255,255,255,0.04);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}

/* options button in card */
.card .card-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.card .options{cursor:pointer;padding:6px 8px;border-radius:8px}
.card .options:hover{background:rgba(255,255,255,0.02)}

/* responsive */
@media (orientation: portrait) {
  .content{flex-direction:column}
  .cards{grid-template-columns: 1fr;}
  .sidebar{order:2}
}
@media (orientation: landscape) {
  .content{flex-direction:row}
  .cards{grid-template-columns: repeat(auto-fill,minmax(280px,1fr))}
  .sidebar{order:1}
}

/* buttons & small */
.btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;font-weight:600;}
.btn-danger{background:linear-gradient(90deg,var(--danger),rgba(200,60,60,0.8));color:white;border:none}
.muted{color:var(--muted);font-size:13px}

/* overlay + dialog */
.overlay{position:fixed;inset:0;display:none;place-items:center;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.65));z-index:1000;}
.overlay.show{display:grid;animation:fadeIn 0.18s ease;}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.dialog{width: min(820px,94vw);background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.06);padding:14px;border-radius:12px;backdrop-filter: blur(14px);box-shadow: 0 18px 40px rgba(0,0,0,0.7);}
.form-row{display:flex;gap:8px;margin:8px 0}
.form-row input[type="text"], .form-row textarea, .form-row input[type="url"], .form-row input[type="password"]{
  flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--accent);outline:none;font-size:14px;}
textarea{min-height:90px;resize:vertical}

/* float menu for plus/options */
.float-menu{position:fixed;display:none;z-index:1200;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border-radius:10px;padding:6px;border:1px solid rgba(255,255,255,0.06);box-shadow: 0 10px 30px rgba(0,0,0,0.6);transition:opacity 0.12s;}
.float-menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;background:transparent;border:none;color:var(--accent);cursor:pointer;font-weight:600;}
.float-menu button.cancel{color:var(--muted);font-weight:600}

/* HIGHLIGHT: make the first option more prominent */
.float-menu button:first-child{
  background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  box-shadow: inset 0 -2px 0 rgba(255,255,255,0.02);
  font-size:15px;
  font-weight:800;
}

/* hover styles */
.float-menu button:hover{ background: rgba(255,255,255,0.02); transform:translateY(-1px); }

/* small */
.small{font-size:13px;color:var(--muted)}
footer{margin-top:8px;color:var(--muted);font-size:13px}
.admin-pill{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);margin-left:8px;font-weight:700}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">lamacOs Kurzbefehle</div>
      <div class="plus" id="plusBtn" title="Neu ➕">+</div>
    </header>

    <div class="content">
      <aside class="sidebar">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Ordner</div>
          <div class="small muted" id="folderCount">0</div>
        </div>
        <div id="folderList"></div>
      </aside>

      <main style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Meine Kurzbefehle</div>
          <div class="small muted">Langes Tippen = mehr Optionen (nur bei eigenen Kurzbefehlen)</div>
        </div>
        <div class="cards" id="cardGrid"></div>
      </main>
    </div>

    <footer>Sync: <span id="syncStatus">Nicht verbunden</span><span id="adminStatus"></span></footer>
  </div>

  <div class="overlay" id="overlay">
    <div class="dialog" id="dialogContent"></div>
  </div>

  <div class="float-menu" id="floatMenu"></div>
  <div class="float-menu" id="folderMenu"></div>

  <!-- Firebase compat SDKs (we use compat so the code below matches your original style) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
// ---- FIREBASE CONFIG: Eingebaut wie gewünscht ----
const FIREBASE_CONFIG = {apiKey: "AIzaSyAncU4-dwtemjWWTg8gIEA1WcAOeI_d87A",
  authDomain: "lamacos-kurzbefehle.firebaseapp.com",
  databaseURL: "https://lamacos-kurzbefehle-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lamacos-kurzbefehle",
  storageBucket: "lamacos-kurzbefehle.firebasestorage.app",
  messagingSenderId: "418008463025",
  appId: "1:418008463025:web:db9be0883fae1470d0d490"};
// special admin password (exact match)
const ADMIN_PASSWORD = "123.lamacosadminadminlamacos123";
// admin session duration in ms (30 minutes)
const ADMIN_DURATION_MS = 30 * 60 * 1000;

// Storage key
const STORAGE_KEY = 'lamacos.shortcuts.v1';

// load state
let state = loadLocal();
if(!state.shortcuts) state.shortcuts = [];
if(!state.folders) state.folders = [];
if(!state.meta) state.meta = { lastUpdated:0, lastWriter:null };

// DOM elements
const cardGrid = document.getElementById('cardGrid');
const folderList = document.getElementById('folderList');
const folderCount = document.getElementById('folderCount');
const overlay = document.getElementById('overlay');
const dialogContent = document.getElementById('dialogContent');
const floatMenu = document.getElementById('floatMenu');
const folderMenu = document.getElementById('folderMenu');
const plusBtn = document.getElementById('plusBtn');
const syncStatusEl = document.getElementById('syncStatus');
const adminStatusEl = document.getElementById('adminStatus');

// firebase vars
let firebaseEnabled=false, firebaseApp=null, firebaseAuth=null, firebaseDb=null, currentUid=null;

// admin
let adminMode = false;
let adminExpiresAt = 0;
function setAdminMode(on){
  adminMode = !!on;
  if(adminMode){
    adminExpiresAt = Date.now() + ADMIN_DURATION_MS;
    adminStatusEl.innerHTML = '<span class="admin-pill">Admin-Modus aktiv</span>';
    console.log('Admin-Modus aktiviert bis', new Date(adminExpiresAt).toLocaleString());
  } else {
    adminExpiresAt = 0;
    adminStatusEl.innerHTML = '';
    console.log('Admin-Modus deaktiviert');
  }
}
function checkAdminExpiry(){
  if(adminMode && Date.now() > adminExpiresAt){
    setAdminMode(false);
  }
}
setInterval(checkAdminExpiry, 1000);

// helpers
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,10); }
function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {shortcuts:[], folders:[], meta:{lastUpdated:0,lastWriter:null}};
    return JSON.parse(raw);
  }catch(e){
    console.warn('loadLocal error', e);
    return {shortcuts:[], folders:[], meta:{lastUpdated:0,lastWriter:null}};
  }
}
function saveLocal(){
  state.meta = state.meta || {};
  state.meta.lastUpdated = Date.now();
  state.meta.lastWriter = currentUid || 'local';
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// sha256 helper
async function sha256hex(str){
  const enc = new TextEncoder().encode(str||'');
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ===== Firebase init & sync (using compat SDKs loaded in HTML) =====
function initFirebaseAuthAndSync(){
  if(typeof firebase === 'undefined'){ setSyncStatus('Firebase SDK nicht geladen'); return; }
  // require that user inserted config
  if(!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey){ setSyncStatus('Firebase nicht konfiguriert (füge FIREBASE_CONFIG ein)'); return; }

  try{
    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.database();
    firebaseEnabled = true;
    setSyncStatus('Verbinde…');

    firebaseAuth.signInAnonymously()
      .then(userCred=>{
        currentUid = userCred.user.uid;
        setSyncStatus('Verbunden (UID:'+currentUid.slice(-6)+')');
        const rootRef = firebaseDb.ref('lamacos_shared_state');

        rootRef.on('value', (snap)=>{
          const cloud = snap.val();
          if(!cloud) return;
          const cloudMeta = cloud.meta || { lastUpdated:0 };
          const localMeta = state.meta || { lastUpdated:0 };
          if(cloudMeta.lastUpdated > localMeta.lastUpdated){
            state = cloud;
            saveLocal();
            render();
            setSyncStatus('Synchronisiert (Cloud übernommen)');
          } else if(cloudMeta.lastUpdated < localMeta.lastUpdated){
            pushStateToCloud(state);
          } else {
            setSyncStatus('Synchronisiert');
          }
        });

        rootRef.once('value').then(snapshot=>{
          const cloudOnce = snapshot.val();
          if(cloudOnce){
            const cloudMeta = cloudOnce.meta || { lastUpdated:0 };
            if(cloudMeta.lastUpdated > (state.meta?.lastUpdated || 0)){
              state = cloudOnce; saveLocal(); render(); setSyncStatus('Initial sync (Cloud übernommen)');
            } else if(cloudMeta.lastUpdated < (state.meta?.lastUpdated || 0)){
              pushStateToCloud(state).then(()=>setSyncStatus('Initial sync (Local gepusht)'));
            } else setSyncStatus('Sync ready');
          } else {
            pushStateToCloud(state).then(()=>setSyncStatus('Initial sync (neu erstellt)'));
          }
        });
      })
      .catch(err=>{
        console.warn('Firebase auth error', err);
        setSyncStatus('Firebase Auth Fehler');
      });

  }catch(e){
    console.warn('Firebase init failed', e);
    firebaseEnabled=false;
    setSyncStatus('Firebase Init fehlgeschlagen');
  }
}

function pushStateToCloud(s){
  if(!firebaseEnabled) return Promise.resolve();
  const toPush = JSON.parse(JSON.stringify(s));
  toPush.meta = toPush.meta || {};
  toPush.meta.lastUpdated = Date.now();
  toPush.meta.lastWriter = currentUid || 'local';
  return firebaseDb.ref('lamacos_shared_state').set(toPush)
    .then(()=>{ state.meta = toPush.meta; saveLocal(); setSyncStatus('Zuletzt synchronisiert: '+ new Date(state.meta.lastUpdated).toLocaleString()); })
    .catch(err=>{ console.warn('Push Fehler', err); setSyncStatus('Fehler beim Push'); });
}

function setSyncStatus(txt){ if(syncStatusEl) syncStatusEl.textContent = txt; }

// ===== UI helpers =====
function showDialog(html){
  dialogContent.innerHTML = html;
  overlay.classList.add('show');
}
function hideDialog(){
  overlay.classList.remove('show');
  floatMenu.style.display = 'none';
  folderMenu.style.display = 'none';
}

// close menus when clicking outside
document.addEventListener('click', (e)=>{
  if(!floatMenu.contains(e.target) && e.target !== plusBtn && !e.target.closest('.options')){
    floatMenu.style.display = 'none';
  }
  if(!folderMenu.contains(e.target)){
    folderMenu.style.display = 'none';
  }
});

// ===== Render UI =====
function render(){
  // render shortcuts
  cardGrid.innerHTML = '';
  state.shortcuts.forEach(sc=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.id = sc.id;
    el.innerHTML = `
      <div class="icon">${sc.icon || '🔗'}</div>
      <div class="meta" style="flex:1">
        <div class="name">${escapeHtml(sc.name)}</div>
        <div class="desc">${escapeHtml(sc.description || sc.link || '')}</div>
      </div>
      <div class="card-right" style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
        <div class="options" title="Optionen" style="cursor:pointer;padding:6px 8px;border-radius:8px">⋮</div>
        ${sc.folderId ? `<div class="small muted" style="font-size:12px;opacity:0.9">📁 ${escapeHtml(getFolderName(sc.folderId)||'')}</div>` : ''}
      </div>
    `;

    // click opens link unless options clicked
    el.addEventListener('click', (e)=>{
      if(e.target.closest('.options')) return;
      if(sc.link) window.open(sc.link, '_blank');
    });

    // options
    const optionsBtn = el.querySelector('.options');
    optionsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openShortcutMenuAtElement(el, sc); });

    addLongPress(el, ()=> openShortcutMenuAtElement(el, sc));

    cardGrid.appendChild(el);
  });

  // render folders
  folderList.innerHTML = '';
  state.folders.forEach(f=>{
    const fe = document.createElement('div');
    fe.className='card';
    fe.dataset.id = f.id;
    fe.style.marginBottom = '10px';
    fe.innerHTML = `
      <div class="icon">📁</div>
      <div class="meta" style="flex:1">
        <div class="name">${escapeHtml(f.name)} ${f.locked ? '🔒' : ''}</div>
        <div class="desc small">${(f.items?.length||0)} Kurzbefehle</div>
      </div>
      <div class="card-right" style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
        <div class="options" title="Ordner Optionen" style="cursor:pointer;padding:6px 8px;border-radius:8px">⋮</div>
      </div>
    `;

    fe.addEventListener('click', ()=> openFolder(f.id) );

    const opt = fe.querySelector('.options');
    opt.addEventListener('click', (e)=>{ e.stopPropagation(); openFolderMenuAtElement(fe, f); });

    addLongPress(fe, ()=> openFolderMenuAtElement(fe, f));

    folderList.appendChild(fe);
  });

  folderCount.textContent = state.folders.length;
}

// longpress (mouse + touch)
function addLongPress(el, callback){
  let timer = null;
  el.addEventListener('mousedown', ()=> timer = setTimeout(callback, 500));
  el.addEventListener('mouseup', ()=> { if(timer) clearTimeout(timer); });
  el.addEventListener('mouseleave', ()=> { if(timer) clearTimeout(timer); });
  el.addEventListener('touchstart', ()=> timer = setTimeout(callback, 600));
  el.addEventListener('touchend', ()=> { if(timer) clearTimeout(timer); });
}

// ===== Menus =====
function openShortcutMenuAtElement(el, sc){
  floatMenu.innerHTML = '';
  addMenuOption(floatMenu, 'Bearbeiten', ()=>{ floatMenu.style.display='none'; openShortcutDialog(sc); });
  addMenuOption(floatMenu, sc.folderId ? 'Aus Ordner entfernen' : 'Zu Ordner verschieben', ()=>{
    floatMenu.style.display='none';
    if(sc.folderId) {
      moveShortcutToFolder(sc.id, null);
    } else {
      showFolderPickerForShortcut(sc);
    }
  });
  addMenuOption(floatMenu, 'Löschen', ()=>{ floatMenu.style.display='none'; deleteShortcut(sc.id); }, true, false);
  addMenuOption(floatMenu, 'Abbrechen', ()=>{ floatMenu.style.display='none'; }, false, true);

  floatMenu.style.display = 'block';
  const rect = el.getBoundingClientRect();
  requestAnimationFrame(()=> {
    const w = floatMenu.offsetWidth;
    floatMenu.style.top = (rect.bottom + 8) + 'px';
    floatMenu.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - w - 8)) + 'px';
  });
}

function openFolderMenuAtElement(el, f){
  folderMenu.innerHTML = '';
  addMenuOption(folderMenu, 'Bearbeiten', ()=>{ folderMenu.style.display='none'; openFolderDialog(f); });
  if(!f.locked) addMenuOption(folderMenu, 'Sperren', ()=>{ folderMenu.style.display='none'; lockFolder(f); });
  else addMenuOption(folderMenu, 'Entsperren', ()=>{ folderMenu.style.display='none'; unlockFolder(f); });
  addMenuOption(folderMenu, 'Löschen', ()=>{ folderMenu.style.display='none'; deleteFolder(f.id); }, true, false);
  addMenuOption(folderMenu, 'Abbrechen', ()=>{ folderMenu.style.display='none'; }, false, true);

  folderMenu.style.display = 'block';
  const rect = el.getBoundingClientRect();
  requestAnimationFrame(()=> {
    const w = folderMenu.offsetWidth;
    folderMenu.style.top = (rect.bottom + 8) + 'px';
    folderMenu.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - w - 8)) + 'px';
  });
}

function addMenuOption(menuEl, text, fn, danger=false, cancel=false){
  const btn = document.createElement('button');
  btn.textContent = text;
  if(cancel) btn.className = 'cancel';
  if(danger) btn.style.color = 'var(--danger)';
  btn.addEventListener('click', fn);
  menuEl.appendChild(btn);

  // make first option visually prominent
  if(menuEl.children.length === 1){
    btn.style.fontWeight = '700';
    btn.style.background = 'rgba(255,255,255,0.03)';
  }
}

// ===== Shortcut Dialog (create/edit) =====
function openShortcutDialog(sc = null){
  const isNew = !sc;
  const id = isNew ? uid() : sc.id;
  const folderOptions = state.folders.map(f=>`<option value="${f.id}" ${sc?.folderId===f.id ? 'selected' : ''}>${escapeHtml(f.name)}</option>`).join('');
  const html = `
    <div style="font-weight:700;margin-bottom:8px">${isNew ? 'Neuer Kurzbefehl' : 'Bearbeite Kurzbefehl'}</div>
    <div class="form-row"><input type="text" id="scName" placeholder="Name" value="${sc?escapeHtml(sc.name):''}"></div>
    <div class="form-row"><input type="text" id="scIcon" placeholder="Icon (Emoji)" value="${sc?escapeHtml(sc.icon):''}"></div>
    <div class="form-row"><input type="url" id="scLink" placeholder="Link" value="${sc?escapeHtml(sc.link):''}"></div>
    <div class="form-row"><textarea id="scDesc" placeholder="Beschreibung">${sc?escapeHtml(sc.description):''}</textarea></div>
    <div class="form-row">
      <select id="scFolder">
        <option value="">Kein Ordner</option>
        ${folderOptions}
      </select>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="scCancel">Abbrechen</button>
      <button id="scSave">Speichern</button>
    </div>
  `;
  showDialog(html);

  document.getElementById('scCancel').addEventListener('click', hideDialog);
  document.getElementById('scSave').addEventListener('click', ()=>{
    const name = document.getElementById('scName').value.trim();
    const icon = document.getElementById('scIcon').value.trim();
    const link = document.getElementById('scLink').value.trim();
    const desc = document.getElementById('scDesc').value.trim();
    const folderId = document.getElementById('scFolder').value || null;
    if(!name) return alert('Name ist Pflicht');

    if(isNew){
      state.shortcuts.push({ id, name, icon, link, description: desc, isOwn:true, folderId });
    } else {
      const s = state.shortcuts.find(x=>x.id===id);
      if(s){ s.name=name; s.icon=icon; s.link=link; s.description=desc; s.folderId = folderId; }
    }

    // normalize folder items
    state.folders.forEach(f=>{ f.items = (f.items||[]).filter(i=>i!==id); });
    if(folderId){
      const target = state.folders.find(f=>f.id===folderId);
      if(target) target.items = target.items || [], target.items.push(id);
    }

    saveLocal();
    if(firebaseEnabled) pushStateToCloud(state);
    render(); hideDialog();
  });
}

// ===== Folder Dialog (create/edit) =====
function openFolderDialog(f = null){
  const isNew = !f;
  const html = `
    <div style="font-weight:700;margin-bottom:8px">${isNew ? 'Neuer Ordner' : 'Bearbeite Ordner'}</div>
    <div class="form-row"><input type="text" id="fName" placeholder="Ordnername" value="${f?escapeHtml(f.name):''}"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="fCancel">Abbrechen</button>
      <button id="fSave">Speichern</button>
    </div>
  `;
  showDialog(html);
  document.getElementById('fCancel').addEventListener('click', hideDialog);
  document.getElementById('fSave').addEventListener('click', ()=>{
    const name = document.getElementById('fName').value.trim();
    if(!name) return alert('Name ist Pflicht');
    if(isNew){
      state.folders.push({ id: uid(), name, items: [], owner:'user', locked:false, pwHash:null });
    } else {
      f.name = name;
    }
    saveLocal();
    if(firebaseEnabled) pushStateToCloud(state);
    render(); hideDialog();
  });
}

// ===== Folder open + contents + password handling =====
async function openFolder(id){
  const f = state.folders.find(x=>x.id===id);
  if(!f) return;
  // admin bypass
  if(f.locked && adminMode){
    showFolderContents(f);
    return;
  }
  if(f.locked){
    const ok = await promptFolderPassword(f);
    if(!ok) return;
    showFolderContents(f);
  } else {
    showFolderContents(f);
  }
}

function showFolderContents(f){
  const html = `
    <div style="font-weight:700;margin-bottom:8px">Ordner: ${escapeHtml(f.name)} ${adminMode ? ' — Admin' : ''}</div>
    <div class="small muted">Enthält ${f.items?.length || 0} Kurzbefehle</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
      ${ (f.items || []).map(id=>{
          const sc = state.shortcuts.find(s=>s.id===id);
          if(!sc) return '';
          return `<div class="card folder-card" data-id="${sc.id}">
                    <div class="icon">${sc.icon||'🔗'}</div>
                    <div class="meta"><div class="name">${escapeHtml(sc.name)}</div></div>
                  </div>`;
        }).join('') }
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="closeFolderBtn">Schließen</button>
    </div>
  `;
  showDialog(html);

  (f.items || []).forEach(id=>{
    const el = dialogContent.querySelector(`.folder-card[data-id="${id}"]`);
    const sc = state.shortcuts.find(s=>s.id===id);
    if(el && sc){
      el.addEventListener('click', ()=> { if(sc.link) window.open(sc.link, '_blank'); });
      addLongPress(el, ()=> openShortcutMenuAtElement(el, sc));
    }
  });

  document.getElementById('closeFolderBtn').addEventListener('click', hideDialog);
}

function promptFolderPassword(f){
  return new Promise(resolve=>{
    const html = `
      <div style="font-weight:700;margin-bottom:8px">Gib Passwort für Ordner ${escapeHtml(f.name)} ein:</div>
      <input id="folderPwInput" type="password" placeholder="Passwort" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--accent);margin-bottom:12px" />
      <div style="display:flex;justify-content:flex-end;gap:6px">
        <button id="folderPwCancel">Abbrechen</button>
        <button id="folderPwOk">OK</button>
      </div>
    `;
    showDialog(html);
    document.getElementById('folderPwCancel').addEventListener('click', ()=> { hideDialog(); resolve(false); }, { once:true });
    document.getElementById('folderPwOk').addEventListener('click', async ()=>{
      const pw = document.getElementById('folderPwInput').value || '';
      // special admin activation shortcut
      if(pw === ADMIN_PASSWORD){
        setAdminMode(true);
        hideDialog();
        alert('Admin-Modus aktiviert für 30 Minuten ✅');
        resolve(true);
        return;
      }
      const hash = await sha256hex(pw);
      if(hash === f.pwHash){ hideDialog(); resolve(true); }
      else { hideDialog(); alert('Falsches Passwort'); resolve(false); }
    }, { once:true });
  });
}

// ===== Folder lock/unlock/delete =====
function lockFolder(f){
  const pw = prompt('Neues Passwort für Ordner:');
  if(!pw) return;
  sha256hex(pw).then(hash=>{
    f.pwHash = hash;
    f.locked = true;
    saveLocal();
    if(firebaseEnabled) pushStateToCloud(state);
    render();
  });
}
function unlockFolder(f){
  // admin can unlock without password
  if(adminMode){
    f.locked = false; f.pwHash = null;
    saveLocal(); if(firebaseEnabled) pushStateToCloud(state); render();
    alert('Ordner per Admin entsperrt');
    return;
  }
  const pw = prompt('Passwort zum Entsperren:');
  if(!pw) return;
  sha256hex(pw).then(hash=>{
    if(hash === f.pwHash){ f.locked = false; saveLocal(); if(firebaseEnabled) pushStateToCloud(state); render(); }
    else alert('Falsches Passwort');
  });
}
function deleteFolder(folderId){
  state.folders = state.folders.filter(x=>x.id!==folderId);
  state.shortcuts.forEach(s=>{ if(s.folderId === folderId) s.folderId = null; });
  saveLocal();
  if(firebaseEnabled) pushStateToCloud(state);
  render();
}

// ===== move shortcut to folder =====
function moveShortcutToFolder(scId, folderId){
  state.folders.forEach(f=>{ f.items = (f.items||[]).filter(i=>i!==scId); });
  const sc = state.shortcuts.find(s=>s.id===scId);
  if(sc) sc.folderId = folderId || null;
  if(folderId){
    const folder = state.folders.find(f=>f.id===folderId);
    if(folder) folder.items = folder.items || [], folder.items.push(scId);
  }
  saveLocal();
  if(firebaseEnabled) pushStateToCloud(state);
  render();
}

// ===== folder picker dialog for moving sc =====
function showFolderPickerForShortcut(sc){
  const options = state.folders.map(f=>`<button class="pickFolderBtn" data-id="${f.id}" style="margin-bottom:6px;padding:8px;border-radius:6px;width:100%;text-align:left">${escapeHtml(f.name)}</button>`).join('');
  const html = `<div style="font-weight:700;margin-bottom:8px">Verschiebe "${escapeHtml(sc.name)}" nach:</div>
    <div style="display:flex;flex-direction:column;gap:6px">${options}</div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="pickCancel">Abbrechen</button></div>`;
  showDialog(html);
  dialogContent.querySelectorAll('.pickFolderBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const fid = btn.dataset.id;
      moveShortcutToFolder(sc.id, fid);
      hideDialog();
    });
  });
  document.getElementById('pickCancel').addEventListener('click', hideDialog);
}

// ===== delete shortcut =====
function deleteShortcut(scId){
  state.shortcuts = state.shortcuts.filter(s=>s.id !== scId);
  state.folders.forEach(f=> f.items = (f.items||[]).filter(i=>i!==scId));
  saveLocal();
  if(firebaseEnabled) pushStateToCloud(state);
  render();
}

// helper
function getFolderName(folderId){
  const f = state.folders.find(x=>x.id===folderId);
  return f ? f.name : '';
}

// setup plus button and global bindings
function setupBindings(){
  plusBtn.addEventListener('click', ()=>{
    floatMenu.innerHTML = '';
    addMenuOption(floatMenu, 'Neuer Kurzbefehl', ()=>{ floatMenu.style.display='none'; openShortcutDialog(); });
    addMenuOption(floatMenu, 'Neuer Ordner', ()=>{ floatMenu.style.display='none'; openFolderDialog(); });
    addMenuOption(floatMenu, 'Abbrechen', ()=>{ floatMenu.style.display='none'; }, false, true);
    floatMenu.style.display = 'block';
    const rect = plusBtn.getBoundingClientRect();
    requestAnimationFrame(()=> {
      const w = floatMenu.offsetWidth;
      floatMenu.style.top = (rect.bottom + 8) + 'px';
      floatMenu.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - w - 8)) + 'px';
    });
  });

  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ hideDialog(); floatMenu.style.display='none'; folderMenu.style.display='none'; }});
}

setupBindings();
render();
// try init firebase if config provided
if(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey) {
  try { initFirebaseAuthAndSync(); } catch(e){ console.warn('Firebase init issue', e); setSyncStatus('Firebase Fehler'); }
} else {
  setSyncStatus('Firebase nicht konfiguriert — füge FIREBASE_CONFIG in script.js ein');
}

// export some helpers (so dynamically created HTML can call them if needed)
window.openShortcutDialog = openShortcutDialog;
window.openFolderDialog = openFolderDialog;
window.openFolder = openFolder;
window.hideDialog = hideDialog;
window.openFolderMenuAtElement = openFolderMenuAtElement;
window.openShortcutMenuAtElement = openShortcutMenuAtElement;
</script>
</body>
</html>